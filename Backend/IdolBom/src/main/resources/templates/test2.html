<!DOCTYPE html>
<html>
<head>
    <title>Redis Pub/Sub WebSocket Test</title>
    <script>
        let socket = null;

        // WebSocket 연결 초기화
        function connect() {
            const chatRoomID = document.getElementById('chatRoomID').value;
            const wsUrl = `http://localhost:8083/ws/chat`;
            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                console.log('Connected to WebSocket for room:', chatRoomID);
                document.getElementById('status').innerText = 'Connected';
                subscribeToRoom(chatRoomID);
            };

            socket.onmessage = function (event) {
                console.log('Message received:', event.data);
                const messages = document.getElementById('messages');
                messages.innerHTML += `<p>${event.data}</p>`;
            };

            socket.onclose = function () {
                console.log('WebSocket disconnected');
                document.getElementById('status').innerText = 'Disconnected';
            };

            socket.onerror = function (error) {
                console.error('WebSocket error:', error);
            };
        }

        // 메시지 전송 (Redis를 통해 발행)
        function sendMessage() {
            const chatRoomID = document.getElementById('chatRoomID').value;
            const content = document.getElementById('content').value;

            // 서버의 REST API를 사용하여 Redis에 메시지 발행
            const request = new XMLHttpRequest();
            request.open('POST', `http://localhost:8083/api/chat/send`, true);
            request.setRequestHeader('Content-Type', 'application/json');
            request.onload = function () {
                if (request.status === 200) {
                    console.log('Message published to Redis:', content);
                } else {
                    console.error('Error publishing message:', request.responseText);
                }
            };
            const message = JSON.stringify({
                chatMessageDTO: {
                    chatRoomID: chatRoomID,
                    content: content
                },
                applicantID: null,
                agentID: null,
                applicantList: [],
                agentList: []
            });
            request.send(message);
        }

        // WebSocket 메시지 발행
        function subscribeToRoom(chatRoomID) {
            const subscriptionMessage = JSON.stringify({
                type: "SUBSCRIBE",
                chatRoomID: chatRoomID
            });
            socket.send(subscriptionMessage);
        }
    </script>
</head>
<body>
<h1>Redis Pub/Sub WebSocket Test</h1>
<p>Status: <span id="status">Disconnected</span></p>
<label for="chatRoomID">Chat Room ID:</label>
<input type="text" id="chatRoomID" placeholder="Enter Chat Room ID">
<br><br>
<label for="content">Message:</label>
<input type="text" id="content" placeholder="Enter your message">
<button onclick="sendMessage()">Send Message</button>
<br><br>
<button onclick="connect()">Connect to WebSocket</button>
<h2>Messages:</h2>
<div id="messages"></div>
</body>
</html>
